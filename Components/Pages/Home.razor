@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using NationsCities.Models
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Państwa, Miasta</PageTitle>

<div class="flex flex-col min-h-screen bg-bg-light dark:bg-bg-dark">
    <!-- Top Navigation -->
    <header class="flex items-center justify-between p-4 pb-2">
        <div class="w-12"></div>
        <button id="home-theme-toggle" 
                type="button"
                class="flex w-12 h-12 items-center justify-center rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700/50 transition-colors cursor-pointer">
            <span id="home-theme-icon" class="material-symbols-outlined text-2xl">light_mode</span>
        </button>
    </header>
    <script>
        (function() {
            var icon = document.getElementById('home-theme-icon');
            if (icon) {
                icon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
            }
            var btn = document.getElementById('home-theme-toggle');
            if (btn) {
                btn.onclick = function(e) {
                    e.preventDefault();
                    var newTheme = window.themeManager.toggle();
                    document.getElementById('home-theme-icon').textContent = newTheme === 'dark' ? 'light_mode' : 'dark_mode';
                };
            }
        })();
    </script>

    <!-- Hero Section -->
    <main class="flex-1 flex flex-col items-center justify-center px-4 -mt-10">
        <!-- Logo/Icon -->
        <div class="relative mb-8">
            <!-- Background Glow -->
            <div class="absolute inset-0 bg-primary/30 blur-[60px] rounded-full scale-150"></div>
            <!-- Main Icon -->
            <div class="relative flex h-32 w-32 items-center justify-center rounded-[2.5rem] bg-gradient-to-br from-surface-light to-bg-light dark:from-surface-dark dark:to-bg-dark shadow-lg border border-slate-200 dark:border-slate-800">
                <span class="material-symbols-outlined text-primary text-7xl">public</span>
                <!-- Anti-cheat Badge -->
                <div class="absolute -bottom-3 -right-3 flex h-12 w-12 items-center justify-center rounded-2xl bg-bg-light dark:bg-bg-dark border-4 border-bg-light dark:border-bg-dark shadow-sm">
                    <div class="flex h-full w-full items-center justify-center rounded-xl bg-green-500/20">
                        <span class="material-symbols-outlined text-green-400 text-2xl">shield_lock</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Title -->
        <div class="flex flex-col gap-2 text-center max-w-md mx-auto">
            <h1 class="text-slate-900 dark:text-white tracking-tight text-4xl font-bold leading-tight">Państwa, Miasta</h1>
            <p class="text-slate-500 dark:text-slate-400 text-base leading-relaxed px-4">
                Klasyczna gra towarzyska z systemem anty-cheat. Graj fair. Graj razem.
            </p>
        </div>
    </main>

    <!-- Bottom Actions -->
    <footer class="w-full px-4 pb-8 pt-4 safe-area-bottom">
        <div class="mx-auto flex max-w-md flex-col gap-3">
            
            @if (!_showJoinInput)
            {
                <!-- Create Room Button -->
                <button @onclick="ShowNicknameForCreate" 
                        class="group relative flex w-full items-center justify-center rounded-full h-14 px-5 bg-primary hover:bg-primary-dark active:scale-[0.98] transition-all text-white shadow-lg shadow-primary/25 btn-press">
                    <span class="material-symbols-outlined mr-2 text-2xl">add_circle</span>
                    <span class="text-lg font-bold">Stwórz pokój</span>
                </button>

                <!-- Join Room Button -->
                <button @onclick="ShowJoinInput"
                        class="flex w-full items-center justify-center rounded-full h-14 px-5 bg-surface-light dark:bg-surface-dark border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 active:scale-[0.98] transition-all text-slate-900 dark:text-white btn-press">
                    <span class="material-symbols-outlined mr-2 text-2xl">login</span>
                    <span class="text-lg font-bold">Dołącz do pokoju</span>
                </button>
            }
            else
            {
                <!-- Join/Create Form -->
                <div class="flex flex-col gap-3 animate-in fade-in duration-200">
                    @if (_isCreating)
                    {
                        <p class="text-center text-slate-500 dark:text-slate-400 text-sm">Tworzenie nowego pokoju</p>
                    }
                    else
                    {
                        <p class="text-center text-slate-500 dark:text-slate-400 text-sm">Dołącz do pokoju</p>
                        <input @bind="_roomCode" 
                               @bind:event="oninput"
                               placeholder="Kod pokoju (opcjonalnie)"
                               maxlength="4"
                               class="w-full h-14 px-5 rounded-full bg-surface-light dark:bg-surface-dark border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-white text-center text-xl font-bold uppercase tracking-widest placeholder:text-slate-400 dark:placeholder:text-slate-500 placeholder:font-normal placeholder:text-base placeholder:tracking-normal focus:border-primary" />
                    }

                    <input @bind="_nickname" 
                           placeholder="Twój nick"
                           maxlength="20"
                           class="w-full h-14 px-5 rounded-full bg-surface-light dark:bg-surface-dark border border-slate-300 dark:border-slate-700 text-slate-900 dark:text-white text-center text-lg placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-primary" />

                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <p class="text-center text-red-400 text-sm">@_error</p>
                    }

                    <button @onclick="SubmitForm" 
                            disabled="@(!CanSubmit)"
                            class="@GetSubmitButtonClass()">
                        <span class="material-symbols-outlined mr-2 text-2xl">@(_isCreating ? "add_circle" : "login")</span>
                        <span class="text-lg font-bold">@(_isCreating ? "Stwórz" : "Dołącz")</span>
                    </button>

                    <!-- Public Rooms List (only when joining) -->
                    @if (!_isCreating && _publicRooms.Count > 0)
                    {
                        <div class="mt-2">
                            <p class="text-center text-green-600 dark:text-green-400 text-xs font-bold uppercase tracking-wider mb-2">
                                <span class="material-symbols-outlined text-sm align-middle mr-1">groups</span>
                                Pokoje publiczne
                            </p>
                            <div class="flex flex-col gap-2 max-h-40 overflow-y-auto">
                                @foreach (var publicRoom in _publicRooms)
                                {
                                    <button @onclick="() => JoinPublicRoom(publicRoom.Code)"
                                            disabled="@(string.IsNullOrWhiteSpace(_nickname))"
                                            class="flex items-center justify-between p-3 rounded-xl bg-green-100 dark:bg-green-900/20 border border-green-300 dark:border-green-700/50 hover:bg-green-200 dark:hover:bg-green-900/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        <div class="flex items-center gap-2">
                                            <span class="material-symbols-outlined text-green-600 dark:text-green-400">meeting_room</span>
                                            <span class="text-slate-900 dark:text-white font-medium">@publicRoom.HostNickname</span>
                                        </div>
                                        <span class="text-slate-500 dark:text-slate-400 text-sm">@publicRoom.PlayerCount/@publicRoom.MaxPlayers graczy</span>
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <button @onclick="CancelForm"
                            class="w-full py-2 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white text-sm font-medium transition-colors">
                        Anuluj
                    </button>
                </div>
            }

            <!-- How to Play -->
            @if (!_showJoinInput)
            {
                <div class="mt-4 flex justify-center">
                    <button class="flex items-center gap-1.5 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-primary transition-colors py-2 px-4 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                        <span class="material-symbols-outlined text-lg">info</span>
                        <span>Jak grać?</span>
                    </button>
                </div>
            }
        </div>
    </footer>
</div>

@code {
    private HubConnection? _hubConnection;
    private bool _showJoinInput;
    private bool _isCreating;
    private string _roomCode = "";
    private string _nickname = "";
    private string? _error;
    private List<PublicRoomInfo> _publicRooms = new();
    private bool _isDarkMode = true;

    private bool CanSubmit => !string.IsNullOrWhiteSpace(_nickname) && 
                              (_isCreating || _roomCode.Length == 4);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Sync state with actual DOM theme on first render only
            try
            {
                var theme = await JS.InvokeAsync<string>("themeManager.get");
                _isDarkMode = theme == "dark";
            }
            catch { /* Ignore if JS not ready */ }
        }
    }


    private void ShowNicknameForCreate()
    {
        _showJoinInput = true;
        _isCreating = true;
        _error = null;
    }

    private async Task ShowJoinInput()
    {
        _showJoinInput = true;
        _isCreating = false;
        _error = null;
        
        // Fetch public rooms
        await LoadPublicRooms();
    }

    private async Task LoadPublicRooms()
    {
        try
        {
            if (_hubConnection == null)
            {
                _hubConnection = new HubConnectionBuilder()
                    .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
                    .Build();
                await _hubConnection.StartAsync();
            }

            _publicRooms = await _hubConnection.InvokeAsync<List<PublicRoomInfo>>("GetPublicRooms");
        }
        catch
        {
            _publicRooms = new();
        }
    }

    private void JoinPublicRoom(string roomCode)
    {
        if (string.IsNullOrWhiteSpace(_nickname)) return;
        Navigation.NavigateTo($"/lobby?code={roomCode}&nick={Uri.EscapeDataString(_nickname)}");
    }

    private void CancelForm()
    {
        _showJoinInput = false;
        _isCreating = false;
        _roomCode = "";
        _nickname = "";
        _error = null;
    }

    private void SubmitForm()
    {
        if (!CanSubmit) return;

        if (_isCreating)
        {
            Navigation.NavigateTo($"/lobby?create=true&nick={Uri.EscapeDataString(_nickname)}");
        }
        else
        {
            Navigation.NavigateTo($"/lobby?code={_roomCode.ToUpperInvariant()}&nick={Uri.EscapeDataString(_nickname)}");
        }
    }

    private string GetSubmitButtonClass()
    {
        var baseClass = "flex w-full items-center justify-center rounded-full h-14 px-5 transition-all btn-press";
        
        if (!CanSubmit)
        {
            return $"{baseClass} bg-slate-700 text-slate-400 cursor-not-allowed";
        }
        
        return $"{baseClass} bg-primary hover:bg-primary-dark active:scale-[0.98] text-white shadow-lg shadow-primary/25";
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
