@page "/finalresults/{RoomCode}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using NationsCities.Models
@inject NavigationManager Navigation
@inject NationsCities.Services.RoomService RoomService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Podsumowanie Gry - Państwa, Miasta</PageTitle>

@if (_isLoading)
{
    <div class="flex items-center justify-center min-h-screen bg-bg-light dark:bg-bg-dark">
        <div class="flex flex-col items-center gap-4">
            <span class="material-symbols-outlined text-4xl text-primary animate-spin">progress_activity</span>
            <p class="text-slate-500 dark:text-slate-400">Ładowanie wyników...</p>
        </div>
    </div>
}
else if (_error != null)
{
    <div class="flex items-center justify-center min-h-screen p-4 bg-bg-light dark:bg-bg-dark">
        <div class="flex flex-col items-center gap-4 text-center">
            <span class="material-symbols-outlined text-4xl text-red-400">error</span>
            <p class="text-red-400">@_error</p>
            <button @onclick="GoHome" class="text-primary hover:underline">Wróć do menu</button>
        </div>
    </div>
}
else if (_room != null && _winner != null)
{
    <div class="relative flex flex-col min-h-screen pb-32 bg-bg-light dark:bg-bg-dark">
        <!-- Header -->
        <header class="sticky top-0 z-20 flex items-center bg-bg-light/80 dark:bg-bg-dark/80 backdrop-blur-md px-4 py-4 justify-between border-b border-slate-200 dark:border-white/5">
            <button @onclick="GoHome" class="text-slate-700 dark:text-white flex size-12 shrink-0 items-center justify-center rounded-full active:bg-slate-200 dark:active:bg-white/10 transition-colors cursor-pointer">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">Podsumowanie</h2>
        </header>

        <!-- Winner Section -->
        <section class="relative flex flex-col items-center w-full px-4 pt-8 pb-6">
            <!-- Glow effect -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-primary/20 rounded-full blur-3xl -z-10 animate-pulse"></div>
            
            <h1 class="text-slate-900 dark:text-white tracking-tight text-[32px] font-bold leading-tight px-4 text-center mb-6 drop-shadow-lg">
                Zwycięstwo!
            </h1>
            
            <div class="flex flex-col gap-4 items-center relative">
                <!-- Trophy icon above avatar -->
                <div class="absolute -top-8 text-yellow-400 z-10 drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]">
                    <span class="material-symbols-outlined" style="font-size: 48px; font-variation-settings: 'FILL' 1;">emoji_events</span>
                </div>
                
                <!-- Winner avatar -->
                <div class="relative group">
                    <div class="h-32 w-32 rounded-full flex items-center justify-center text-3xl font-bold text-white border-4 border-primary shadow-[0_0_30px_-5px_rgba(37,140,244,0.6)] avatar-initials"
                         style="background-color: @_winner.AvatarColor">
                        @_winner.GetInitials()
                    </div>
                    <div class="absolute bottom-0 right-0 bg-primary text-white rounded-full p-1.5 border-4 border-bg-light dark:border-bg-dark flex items-center justify-center shadow-sm">
                        <span class="material-symbols-outlined" style="font-size: 18px;">star</span>
                    </div>
                </div>
                
                <!-- Winner name and score -->
                <div class="flex flex-col items-center justify-center">
                    <p class="text-slate-900 dark:text-white text-[24px] font-bold leading-tight tracking-[-0.015em] text-center">@_winner.Nickname</p>
                    <div class="mt-2 flex items-center gap-2">
                        <div class="px-4 py-1 bg-primary/20 rounded-full border border-primary/20">
                            <p class="text-primary text-sm font-bold leading-normal text-center tracking-wide">@_winner.TotalScore PKT</p>
                        </div>
                        @{ var winnerPenalty = GetTotalPenalty(_winner); }
                        @if (winnerPenalty > 0)
                        {
                            <div class="px-3 py-1 bg-red-500/20 rounded-full border border-red-500/20">
                                <p class="text-red-400 text-sm font-bold leading-normal text-center">-@winnerPenalty</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </section>

        <!-- Final Ranking (starting from #2) -->
        <section class="px-4 mt-4">
            <h3 class="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase tracking-wider mb-4 px-2">Ranking Końcowy</h3>
            <div class="flex flex-col gap-3">
                @foreach (var (player, index) in _sortedPlayers.Skip(1).Select((p, i) => (p, i + 2)))
                {
                    var playerPenalty = GetTotalPenalty(player);
                    var progressPercent = _maxScore > 0 ? (player.TotalScore * 100 / _maxScore) : 0;
                    
                    <div class="group relative flex items-center gap-4 bg-surface-light dark:bg-surface-dark p-3 pr-4 rounded-[20px] shadow-sm border border-slate-200 dark:border-white/5 active:scale-[0.99] transition-transform">
                        <div class="flex items-center justify-center w-8 text-slate-500 font-bold text-lg">@index</div>
                        <div class="h-12 w-12 rounded-full flex items-center justify-center text-sm font-bold text-white shrink-0 border border-slate-200 dark:border-white/10 avatar-initials"
                             style="background-color: @player.AvatarColor">
                            @player.GetInitials()
                        </div>
                        <div class="flex flex-col flex-1 min-w-0">
                            <p class="text-slate-900 dark:text-white text-base font-semibold leading-normal truncate">@player.Nickname</p>
                            <div class="flex items-center gap-2">
                                <div class="h-1.5 w-full max-w-[80px] bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-slate-400" style="width: @(progressPercent)%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            @if (playerPenalty > 0)
                            {
                                <span class="px-2 py-1 bg-red-500/20 rounded-full text-xs font-bold text-red-400">-@playerPenalty</span>
                            }
                            <div class="flex flex-col items-end">
                                <p class="text-white text-lg font-bold leading-normal">@player.TotalScore</p>
                                <p class="text-xs text-slate-500">pkt</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </section>

        <!-- Fair Play Section -->
        @if (_allViolations.Any())
        {
            <section class="px-4 mt-8">
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider">Kontrola Fair Play</h3>
                    <span class="flex items-center gap-1 text-[10px] font-bold bg-green-500/20 text-green-500 px-2 py-0.5 rounded-full uppercase tracking-wide">
                        System Aktywny
                    </span>
                </div>
                
                <div class="bg-surface-dark rounded-[24px] overflow-hidden border border-white/10 shadow-sm">
                    <!-- Violations header -->
                    <div class="p-4 bg-orange-500/10 flex items-center gap-3 border-b border-white/5">
                        <div class="bg-orange-500/20 p-2 rounded-full text-orange-400">
                            <span class="material-symbols-outlined">warning</span>
                        </div>
                        <p class="text-sm text-slate-200 font-medium leading-tight">
                            Wykryto @_allViolations.Count @GetViolationWord(_allViolations.Count) w tej rozgrywce.
                        </p>
                    </div>
                    
                    <!-- Violations list -->
                    <div class="divide-y divide-white/5">
                        @foreach (var violation in _allViolations.Take(10))
                        {
                            <div class="p-4 flex gap-3">
                                <div class="h-2 w-2 mt-2 rounded-full bg-orange-500 shrink-0"></div>
                                <div class="flex flex-col gap-1 w-full">
                                    <div class="flex justify-between items-start w-full">
                                        <p class="text-sm font-bold text-white">
                                            @violation.PlayerNickname
                                            <span class="font-normal text-slate-500 text-xs ml-1">Runda @violation.Violation.RoundNumber</span>
                                        </p>
                                        <span class="text-[10px] font-mono text-slate-400 whitespace-nowrap">
                                            @(violation.Violation.Penalty > 0 ? $"-{violation.Violation.Penalty} pkt" : "Ostrzeżenie")
                                        </span>
                                    </div>
                                    <p class="text-xs text-slate-400 leading-relaxed">
                                        @GetViolationDescription(violation.Violation)
                                    </p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </section>
        }

        <div class="h-8"></div>

        <!-- Footer Actions -->
        <div class="fixed bottom-0 left-0 w-full z-30">
            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-bg-light dark:from-bg-dark via-bg-light/90 dark:via-bg-dark/90 to-transparent pointer-events-none"></div>
            <div class="relative w-full max-w-md mx-auto px-4 pb-6 pt-4 flex gap-3 items-stretch">
                <button @onclick="ShareResults"
                        class="flex items-center justify-center aspect-square h-14 bg-surface-light dark:bg-surface-dark text-slate-700 dark:text-white rounded-full shadow-lg border border-slate-200 dark:border-white/10 active:scale-95 transition-transform hover:bg-slate-100 dark:hover:bg-white/5">
                    <span class="material-symbols-outlined">ios_share</span>
                </button>
                <button @onclick="ReturnToLobby"
                        class="flex-1 h-14 bg-primary hover:bg-primary/90 text-white text-base font-bold rounded-full shadow-[0_4px_20px_-4px_rgba(37,140,244,0.5)] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <span>Powrót do Lobby</span>
                    <span class="material-symbols-outlined" style="font-size: 20px;">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string RoomCode { get; set; } = "";

    private HubConnection? _hubConnection;
    private Room? _room;
    private Player? _winner;
    private List<Player> _sortedPlayers = [];
    private List<ViolationWithPlayer> _allViolations = [];
    private int _maxScore = 1;
    private string _nickname = "";
    private string? _error;
    private bool _isLoading = true;

    private record ViolationWithPlayer(Violation Violation, string PlayerNickname);

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _nickname = query["nick"] ?? "";

        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
                .Build();

            _hubConnection.On("OnGameEnded", () =>
            {
                Navigation.NavigateTo("/");
            });

            _hubConnection.On<string>("OnReturnToLobby", (roomCode) =>
            {
                Navigation.NavigateTo($"/lobby?code={roomCode}&nick={Uri.EscapeDataString(_nickname)}");
            });

            await _hubConnection.StartAsync();

            if (!string.IsNullOrEmpty(_nickname))
            {
                await _hubConnection.InvokeAsync<bool>("JoinGame", RoomCode, _nickname);
            }

            _room = RoomService.GetRoom(RoomCode);

            if (_room == null)
            {
                _error = "Gra nie istnieje.";
                _isLoading = false;
                return;
            }

            // Sort players by total score
            _sortedPlayers = _room.Players.OrderByDescending(p => p.TotalScore).ToList();
            _winner = _sortedPlayers.FirstOrDefault();
            _maxScore = _winner?.TotalScore ?? 1;

            // Gather all violations with player names
            _allViolations = _room.Players
                .SelectMany(p => p.Violations.Select(v => new ViolationWithPlayer(v, p.Nickname)))
                .OrderBy(v => v.Violation.RoundNumber)
                .ThenBy(v => v.Violation.OccurredAt)
                .ToList();

            _isLoading = false;
        }
        catch (Exception ex)
        {
            _error = $"Błąd: {ex.Message}";
            _isLoading = false;
        }
    }

    private string GetViolationWord(int count)
    {
        if (count == 1) return "naruszenie";
        if (count >= 2 && count <= 4) return "naruszenia";
        return "naruszeń";
    }

    private string GetViolationDescription(Violation v)
    {
        return v.Type switch
        {
            ViolationType.FocusLost => $"Utrata fokusu okna przez {v.DurationSeconds:F1}s.",
            ViolationType.TabSwitch => $"Zmiana karty/okna przez {v.DurationSeconds:F1}s.",
            ViolationType.ConnectionUnstable => "Niestabilne połączenie.",
            _ => "Nieznane naruszenie."
        };
    }

    private void ShareResults()
    {
        // TODO: Implement share functionality
    }

    private async Task ReturnToLobby()
    {
        // Clear anti-cheat session so next game starts fresh
        try
        {
            await JSRuntime.InvokeVoidAsync("antiCheatTracker.clearSession");
        }
        catch { /* Ignore if not available */ }
        
        // Just navigate this player to lobby - no broadcast needed
        // Each player clicks independently when ready to return
        Navigation.NavigateTo($"/lobby?code={RoomCode}&nick={Uri.EscapeDataString(_nickname)}&rejoin=true");
    }

    private int GetTotalPenalty(Player player)
    {
        return player.Violations.Sum(v => v.Penalty);
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
