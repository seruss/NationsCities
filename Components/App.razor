<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#101922" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Państwa, Miasta</title>
    <base href="/" />
    
    <!-- Theme initialization (must run before page renders to prevent flash) -->
    <script>
        // Theme Manager - defined in head so it's available immediately for onclick handlers
        window.ThemeManager = class {
            constructor() {
                this._storageKey = 'theme_preference';
                this._init();
            }

            _init() {
                var stored = localStorage.getItem(this._storageKey);
                var theme = stored || 'dark';
                this._apply(theme);
            }

            toggle() {
                var current = this.get();
                var next = current === 'dark' ? 'light' : 'dark';
                this._apply(next);
                localStorage.setItem(this._storageKey, next);
                // Update all toggle button icons
                document.querySelectorAll('[data-theme-toggle] span').forEach(function(span) {
                    span.textContent = next === 'dark' ? 'light_mode' : 'dark_mode';
                });
                return next;
            }

            get() {
                return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            }

            set(theme) {
                this._apply(theme);
                localStorage.setItem(this._storageKey, theme);
            }

            _apply(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                var metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) {
                    metaTheme.setAttribute('content', theme === 'dark' ? '#101922' : '#f5f7f8');
                }
            }
            
            // Re-apply from localStorage (for after navigation)
            reapply() {
                var stored = localStorage.getItem(this._storageKey);
                var theme = stored || 'dark';
                this._apply(theme);
            }
        };
        window.themeManager = new window.ThemeManager();
        
        // Event delegation for theme toggle buttons - works even after Blazor re-renders
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-theme-toggle]');
            if (btn) {
                e.preventDefault();
                e.stopPropagation();
                window.themeManager.toggle();
            }
        }, true); // Use capture phase to handle before Blazor
        
        // Re-apply theme after Blazor enhanced navigation
        // This listener fires after Blazor has finished updating the DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for Blazor's enhancedload event (fires after enhanced navigation)
            if (typeof Blazor !== 'undefined') {
                Blazor.addEventListener('enhancedload', function() {
                    window.themeManager.reapply();
                });
            }
        });
        
        // Also use MutationObserver as backup to detect when body content changes
        var observer = new MutationObserver(function(mutations) {
            // Re-apply theme whenever body content changes
            window.themeManager.reapply();
        });
        observer.observe(document.documentElement, { childList: true, subtree: false });
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@400,1&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#258cf4",
                        "primary-dark": "#1a6fc0",
                        "bg-light": "#f5f7f8",
                        "bg-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1A2633",
                        "surface-darker": "#151e29",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "2xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="NationsCities.styles.css" />
    <HeadOutlet />
</head>

<body class="bg-bg-light dark:bg-bg-dark font-sans text-slate-900 dark:text-white antialiased min-h-screen touch-manipulation">
    <Routes />
    
    <!-- Custom Blazor Reconnect Modal -->
    <div id="components-reconnect-modal" class="components-reconnect-hide">
        <div class="reconnect-overlay">
            <div class="reconnect-content">
                <div class="reconnect-spinner"></div>
                <p class="reconnect-text">Ponowne łączenie...</p>
            </div>
        </div>
    </div>
    
    <script src="app.js?v=22"></script>
    <script src="_framework/blazor.web.js"></script>
</body>

</html>
